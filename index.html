<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ íƒ„ì†Œ ì˜¤ë¦„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/byMjbXs1/Gemini-Generated-Image-s04wxfs04wxfs04w-1.png?dl=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="simulation-container">
        <div id="game-display-area" class="flex-grow flex flex-col justify-between p-4">
            <header>
                <h1 class="text-3xl sm:text-4xl font-bold">ë‚˜ì˜ íƒ„ì†Œ ì˜¤ë¦„</h1>
            </header>
            
            <main class="flex-grow flex flex-col items-center justify-center">
                <div class="oreum-background">
                    <div id="oreum" class="oreum level-1">
                        <div class="tree-container">
                            <div id="tree1" class="tree"><div class="trunk"></div><div class="leaves"></div></div>
                            <div id="tree2" class="tree"><div class="trunk"></div><div class="leaves"></div></div>
                        </div>
                    </div>
                </div>
            </main>
            
            <div class="dashboard">
                <div class="stat">ë ˆë²¨ <span id="level-value" class="text-2xl sm:text-3xl">1</span></div>
                <div class="stat">ìƒëª…ë ¥ <span id="life-force-value" class="text-2xl sm:text-3xl">0</span></div>
                <div class="stat">ê°ì¶•ëŸ‰ <span id="ghg-reduced-value" class="text-2xl sm:text-3xl">0g</span></div>
            </div>
            
            <div class="sensor-dashboard">
                <p>í˜„ì¬ ì´ë™ìˆ˜ë‹¨: <span id="transport-display" class="font-bold text-blue-600 animate-pulse">ëŒ€ê¸° ì¤‘...</span></p>
                <p>í˜„ì¬ ì†ë„: <span id="speed-display" class="value">0 m/s</span></p>
                <p>ê°€ì†ë„: <span id="acc-display" class="value">0 m/sÂ²</span></p>
                <p id="user-info-display" class="text-xs truncate text-gray-400">ë¡œê·¸ì¸í•˜ê³  ì˜¤ë¦„ì„ í‚¤ì›Œë³´ì„¸ìš”!</p>
                <p id="db-status" class="text-xs text-gray-400">Firebase ì´ˆê¸°í™” ì¤‘...</p>
            </div>
        </div>
        
        <footer class="w-full border-t border-gray-300 bg-white">
            <nav class="flex justify-around items-center h-16 text-gray-500">
                <a id="mission-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></a>
                <a id="rewards-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg></a>
                <a id="profile-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></a>
            </nav>
        </footer>
    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title" class="font-bold text-lg mb-2"></h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">í™•ì¸</button>
        </div>
    </div>
    
    <div id="side-panel-overlay" class="side-panel-overlay">
        <div id="side-panel" class="side-panel">
            <div class="side-panel-header">
                <h2 id="side-panel-title">ë§ˆì´í˜ì´ì§€</h2>
                <button id="side-panel-close-btn">&times;</button>
            </div>
            <div class="side-panel-content">
                <div id="logged-out-view">
                    <p class="text-center text-sm mb-4">ë¡œê·¸ì¸í•˜ê³  ì˜¤ë¦„ì„ í‚¤ì›Œë³´ì„¸ìš”!</p>
                    <button id="google-sign-in-btn" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" class="w-6 h-6"><span>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</span></button>
                </div>
                
                <div id="logged-in-view" class="hidden">
                    <p id="panel-user-info" class="text-center text-sm mb-4">ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <div class="flex flex-col gap-4">
                        <div class="stat"><p>í˜„ì¬ ë ˆë²¨</p><span id="panel-level-value">1</span></div>
                        <div class="stat"><p>ì´ ê°ì¶•ëŸ‰</p><span id="panel-ghg-reduced-value">0g</span></div>
                    </div>
                    
                    <button id="subscribe-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                        ì•Œë¦¼ êµ¬ë…í•˜ê¸°
                    </button>

                    <button id="sign-out-btn" class="mt-8 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ë³´ìƒ ëª¨ë‹¬ -->
    <div id="rewards-modal-overlay" class="rewards-modal-overlay">
        <div id="rewards-modal" class="rewards-modal-content">
            <h2 class="text-2xl font-bold text-gray-800">ì˜¤ëŠ˜ì˜ ë³´ìƒ</h2>
            <p class="text-sm text-gray-500 mb-4">íƒ„ì†Œ ê°ì¶• í™œë™ìœ¼ë¡œ ë³´ìƒì„ íšë“í•˜ì„¸ìš”!</p>
            <div id="reward-list-container" class="flex flex-col gap-3 w-full">
                <!-- ë³´ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
            <button id="rewards-close-btn" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-full">ë‹«ê¸°</button>
        </div>
    </div>
    
    <!-- ë¯¸ì…˜ ëª¨ë‹¬ (ìˆ˜ì •ë¨) -->
    <div id="mission-modal-overlay" class="mission-modal-overlay">
        <div id="mission-modal" class="mission-modal-content">
            <div style="height: 700px; overflow-y: auto">
                <h2 class="text-2xl font-bold text-gray-800">ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h2>
                <p class="text-gray-600 mb-4">ì¹œí™˜ê²½ í™œë™ìœ¼ë¡œ ìƒëª…ë ¥ì„ ì–»ê³  ì˜¤ë¦„ì„ í‚¤ì›Œë³´ì„¸ìš”!</p>
                <!-- ğŸŒŸ ë¯¸ì…˜ ëª©ë¡ ë™ì  ì»¨í…Œì´ë„ˆë¡œ êµì²´ ğŸŒŸ -->
                <div id="mission-list-container" class="mission-list space-y-3 mt-4 text-left">
                    <!-- ë¯¸ì…˜ í•­ëª©ì´ ì—¬ê¸°ì— JavaScriptë¡œ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                </div>
                <!-- ğŸŒŸ êµì²´ ë ğŸŒŸ -->
                <button id="mission-close-btn" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-full">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    <script src="https://www.chatbase.co/embed.min.js" id="KwLJdboX39BEnTOig8OKU"></script>
    <script type="module" src="script.js"></script>

    <!-- ============================================== -->
    <!-- ğŸŒŸ ìƒˆë¡œ ì¶”ê°€ëœ AI ë¯¸ì…˜ ì¸ì¦ ìƒì„¸ ëª¨ë‹¬ (ai-auth-modal-overlay) ğŸŒŸ -->
    <!-- ============================================== -->
    <div id="ai-auth-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex justify-center items-center p-4 transition-opacity duration-300 opacity-0">
        <div class="modal-content-ai bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-start">
                <h3 id="auth-mission-title" class="text-2xl font-bold text-green-700">ë¯¸ì…˜ ìƒì„¸</h3>
                <button class="text-gray-500 hover:text-gray-700 text-3xl leading-none" onclick="closeAIAuthModal()">&times;</button>
            </div>
            <p id="auth-mission-desc" class="text-gray-600 mt-2 mb-4 text-sm border-b pb-3"></p>

            <div id="auth-content">
                <label for="mission-image" class="block text-left text-sm font-medium text-gray-700 mb-2">
                    ë¯¸ì…˜ ì¸ì¦ ì‚¬ì§„ ì—…ë¡œë“œ
                </label>
                <input type="file" id="mission-image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-sm">
                
                <img id="image-preview" class="w-full h-48 object-cover rounded-lg border border-gray-200 hidden mb-4" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°">

                <button id="verify-mission-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    AIë¡œ ë¯¸ì…˜ ì¸ì¦í•˜ê¸°
                </button>
                
                <div id="auth-status-area" class="mt-4 p-3 rounded-lg text-sm text-left hidden">
                    <p id="auth-message" class="font-medium"></p>
                </div>
            </div>

            <button class="w-full mt-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150" onclick="closeAIAuthModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ğŸŒŸ AI ì¸ì¦ ë° ë™ì  ë¯¸ì…˜ ë¡œë”© ë¡œì§ (ìƒˆë¡œ ì¶”ê°€ëœ ë‚´ìš©) ğŸŒŸ -->
    <script type="module">
        // ğŸŒŸ AI ë¯¸ì…˜ ì¸ì¦ ê´€ë ¨ DOM ìš”ì†Œ ë° ë³€ìˆ˜ ğŸŒŸ
        const AI_INCREMENT = 20; // AI ì¸ì¦ ì„±ê³µ ì‹œ ì¶”ê°€ë˜ëŠ” ìƒëª…ë ¥
        
        const aiAuthModalOverlay = document.getElementById('ai-auth-modal-overlay');
        const authMissionTitle = document.getElementById('auth-mission-title');
        const authMissionDesc = document.getElementById('auth-mission-desc');
        const missionImageInput = document.getElementById('mission-image');
        const imagePreview = document.getElementById('image-preview');
        const verifyMissionBtn = document.getElementById('verify-mission-btn');
        const authStatusArea = document.getElementById('auth-status-area');
        const authMessage = document.getElementById('auth-message');
        
        // ë¯¸ì…˜ ë¡œë”© ê´€ë ¨ ìš”ì†Œ
        const missionListContainer = document.getElementById('mission-list-container');
        
        // ë¯¸ì…˜ ë°ì´í„° (ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ ë°˜ì˜í•˜ì—¬ ì—…ë°ì´íŠ¸)
        const MISSION_DATA = [
            { 
                icon: 'ğŸš¶â€â™‚ï¸â€â¡ï¸', 
                title: 'í”Œë¡œê¹…ì„ ì‹¤ì²œí•˜ê¸°', 
                description: 'ì¡°ê¹…í•˜ë©´ì„œ ì“°ë ˆê¸°ë¥¼ ì¤ëŠ” í™œë™ìœ¼ë¡œ í™˜ê²½ ë³´í˜¸ì™€ ìš´ë™ì„ ë™ì‹œì— í•˜ì„¸ìš”. (ì˜ˆ: ì£¼ìš´ ì“°ë ˆê¸° ì‚¬ì§„)', 
                aiEnabled: true 
            },
            { 
                icon: 'ğŸ¥¤', 
                title: 'í…€ë¸”ëŸ¬ ì‚¬ìš©', 
                description: 'ì¼íšŒìš© ì»µ ëŒ€ì‹  í…€ë¸”ëŸ¬ë¥¼ ì‚¬ìš©í•´ ì“°ë ˆê¸°ë¥¼ ì¤„ì´ì„¸ìš”. (ì˜ˆ: í…€ë¸”ëŸ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ì§„)', 
                aiEnabled: true 
            },
            { 
                icon: 'ğŸªœ', 
                title: 'ê³„ë‹¨ ì´ìš©', 
                description: 'ê°€ê¹Œìš´ ì¸µì€ ì—˜ë¦¬ë² ì´í„° ëŒ€ì‹  ê³„ë‹¨ì„ ì´ìš©í•´ ì „ë ¥ ì†Œë¹„ë¥¼ ì¤„ì´ì„¸ìš”. (AI ì¸ì¦ ê°€ëŠ¥)', 
                aiEnabled: true 
            },
            { 
                icon: 'ğŸ–¥ï¸', 
                title: 'ì»´í“¨í„° ì ˆì „ ëª¨ë“œ í™œìš©', 
                description: 'ì ì‹œ ìë¦¬ë¥¼ ë¹„ìš¸ ë•ŒëŠ” ì ˆì „ ëª¨ë“œë¡œ ì „í™˜í•˜ê±°ë‚˜ ì „ì›ì„ ë„ì„¸ìš”. (ì¼ë°˜ ì¸ì¦)', 
                aiEnabled: false 
            },
            { 
                icon: 'â™»ï¸', 
                title: 'íƒë°° ë°•ìŠ¤ ì¬í™œìš©', 
                description: 'ë°•ìŠ¤ì— ë¶™ì–´ ìˆëŠ” í…Œì´í”„, ì†¡ì¥ ìŠ¤í‹°ì»¤ ë“± ì´ë¬¼ì§ˆì„ ì œê±°í•˜ê³  ë°•ìŠ¤ë¥¼ í¼ì³ ë°°ì¶œí•˜ì„¸ìš”. (ì¼ë°˜ ì¸ì¦)', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸ‘•', 
                title: 'íŒ¨ìŠ¤íŠ¸ íŒ¨ì…˜ ì§€ì–‘', 
                description: 'ì €ë ´í•˜ê³  ìœ í–‰ì— ë”°ë¼ ìì£¼ ë°”ë€ŒëŠ” ì˜·ë³´ë‹¤ëŠ” ì˜¤ë˜ ì…ì„ ìˆ˜ ìˆëŠ” ì¢‹ì€ ì˜·ì„ êµ¬ë§¤í•˜ì„¸ìš”. (ì¼ë°˜ ì¸ì¦)', 
                aiEnabled: false 
            },
            { 
                icon: 'â˜˜ï¸', 
                title: 'ì—ì½” ìº í˜ì¸ ì°¸ì—¬', 
                description: 'í™˜ê²½ ë‹¨ì²´ì—ì„œ ì£¼ê´€í•˜ëŠ” ìº í˜ì¸ì´ë‚˜ ì„œëª… ìš´ë™ì— ì°¸ì—¬í•˜ì„¸ìš”. (ì¼ë°˜ ì¸ì¦)', 
                aiEnabled: false 
            },
            // ë‚˜ë¨¸ì§€ ë¯¸ì…˜ í•­ëª©ì€ AI ì¸ì¦ì´ ì•„ë‹ˆë¯€ë¡œ ì„ì‹œë¡œ ì¼ë°˜ ì¸ì¦ ì²˜ë¦¬
            { 
                icon: 'ğŸ”Œ', 
                title: 'í”ŒëŸ¬ê·¸ ë½‘ê¸°', 
                description: 'ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê°€ì „ì œí’ˆì˜ í”ŒëŸ¬ê·¸ë¥¼ ë½‘ì•„ ëŒ€ê¸° ì „ë ¥ì„ ì°¨ë‹¨í•˜ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸŒ¡ï¸', 
                title: 'ëƒ‰ë‚œë°© ì˜¨ë„ ì¡°ì ˆ', 
                description: 'ì—¬ë¦„ì² ì—ëŠ” ì—ì–´ì»¨ ì˜¨ë„ë¥¼ 26Â°C ì´ìƒìœ¼ë¡œ, ê²¨ìš¸ì² ì—ëŠ” ë‚œë°© ì˜¨ë„ë¥¼ 20Â°C ì´í•˜ë¡œ ìœ ì§€í•˜ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸ’¡', 
                title: 'ì „ë“± ë„ê¸°', 
                description: 'ë¶ˆí•„ìš”í•œ ì¡°ëª…ì€ ë„ê³  ì—ë„ˆì§€ë¥¼ ì ˆì•½í•˜ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸš°', 
                title: 'ë¬¼ ì ˆì•½', 
                description: 'ì–‘ì¹˜í•  ë•Œ ì»µ ì‚¬ìš©í•˜ê¸°, ìƒ¤ì›Œ ì‹œê°„ ì¤„ì´ê¸° ë“± ë¬¼ì„ ì•„ê»´ ì“°ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸ’¸', 
                title: 'ì¹œí™˜ê²½ ì œí’ˆ êµ¬ë§¤', 
                description: 'í™˜ê²½ë§ˆí¬ê°€ ìˆëŠ” ì œí’ˆì´ë‚˜ ì¬í™œìš© ì†Œì¬ë¡œ ë§Œë“  ì œí’ˆì„ êµ¬ë§¤í•˜ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸ¥•', 
                title: 'ì¤‘ê³  ë¬¼í’ˆ í™œìš©', 
                description: 'í•„ìš”í•œ ë¬¼ê±´ì€ ì¤‘ê³ ë¡œ êµ¬ë§¤í•˜ê±°ë‚˜, ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¬¼ê±´ì€ íŒë§¤í•˜ê±°ë‚˜ ê¸°ë¶€í•˜ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸ›’', 
                title: 'ì§€ì—­ ë†ì‚°ë¬¼ ì´ìš©', 
                description: 'ì§€ì—­ ë†ì‚°ë¬¼ì„ êµ¬ë§¤í•´ ìš´ì†¡ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” íƒ„ì†Œ ë°°ì¶œëŸ‰ì„ ì¤„ì´ì„¸ìš”.', 
                aiEnabled: false 
            },
            { 
                icon: 'ğŸš', 
                title: 'ì”ë°˜ ë‚¨ê¸°ì§€ ì•Šê¸°', 
                description: 'ë¨¹ì„ ë§Œí¼ë§Œ ì¡°ë¦¬í•˜ê³  ë‚¨ê¸°ì§€ ì•Šì•„ ìŒì‹ë¬¼ ì“°ë ˆê¸° ë° ë¬¼ ë‚­ë¹„ë¥¼ ì¤„ì´ì„¸ìš”.', 
                aiEnabled: false 
            }
        ];

        let currentMission = { title: '', description: '' }; // í˜„ì¬ ì¸ì¦í•˜ë ¤ëŠ” ë¯¸ì…˜ ì •ë³´
        
        // ğŸŒŸ ë¯¸ì…˜ ëª©ë¡ ë™ì  ë¡œë“œ í•¨ìˆ˜ ğŸŒŸ
        window.loadMissions = function() {
            missionListContainer.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            
            MISSION_DATA.forEach(mission => {
                const li = document.createElement('li');
                li.className = 'mission-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-150';
                
                // AI ì¸ì¦ì´ ê°€ëŠ¥í•œ ë¯¸ì…˜ë§Œ handleMissionClick í•¸ë“¤ëŸ¬ë¥¼ ì—°ê²°
                if (mission.aiEnabled) {
                    // ë¯¸ì…˜ í´ë¦­ ì‹œ, ë¯¸ì…˜ ëª¨ë‹¬ì„ ë‹«ê³  AI ì¸ì¦ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
                    li.setAttribute('onclick', `closeMissionModal(); handleMissionClick('${mission.icon.replace(/'/g, "\\'") + ' ' + mission.title.replace(/'/g, "\\'")}', '${mission.description.replace(/'/g, "\\'")}')`);
                    li.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 flex items-center">
                            ${mission.icon} ${mission.title}
                            <span class="ml-2 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">AI ì¸ì¦</span>
                        </h3>
                        <p class="text-sm text-gray-600">${mission.description.split('(')[0].trim()}</p>
                    `;
                } else {
                    // AI ì¸ì¦ì´ ì•„ë‹Œ ë¯¸ì…˜ì€ ì¼ë°˜ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ë¥¼ ê±°ì¹©ë‹ˆë‹¤. (ì„ì‹œ ë¡œì§)
                    li.setAttribute('onclick', `closeMissionModal(); showModal('ì¼ë°˜ ì¸ì¦', '${mission.title} ë¯¸ì…˜ì€ ìˆ˜ë™ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.')`);
                    li.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 flex items-center">
                            ${mission.icon} ${mission.title}
                            <span class="ml-2 text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">ìˆ˜ë™ ì¸ì¦</span>
                        </h3>
                        <p class="text-sm text-gray-600">${mission.description.split('(')[0].trim()}</p>
                    `;
                }

                missionListContainer.appendChild(li);
            });
        }

        // ğŸŒŸ AI ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ğŸŒŸ
        window.closeAIAuthModal = function() {
            aiAuthModalOverlay.classList.add('opacity-0');
            aiAuthModalOverlay.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                aiAuthModalOverlay.classList.add('hidden');
            }, 300);
        }
        
        // ë¯¸ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬: AI ì¸ì¦ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
        window.handleMissionClick = function(title, description) {
            currentMission = { title, description };
            authMissionTitle.textContent = title;
            authMissionDesc.textContent = description.replace(' (ì˜ˆ:', ' (AI ë¶„ì„ì„ ìœ„í•´ ì¸ì¦ ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆ:'); 
            
            // UI ì´ˆê¸°í™”
            missionImageInput.value = '';
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            authStatusArea.classList.add('hidden');
            authMessage.textContent = '';
            verifyMissionBtn.disabled = false;
            verifyMissionBtn.textContent = 'AIë¡œ ë¯¸ì…˜ ì¸ì¦í•˜ê¸°';
            verifyMissionBtn.classList.remove('bg-gray-400');
            verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // ëª¨ë‹¬ í‘œì‹œ
            aiAuthModalOverlay.classList.remove('hidden');
            setTimeout(() => {
                aiAuthModalOverlay.classList.remove('opacity-0');
                aiAuthModalOverlay.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ìƒíƒœ ì´ˆê¸°í™” ë¦¬ìŠ¤ë„ˆ
        missionImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
            }
            // ìƒíƒœ ì´ˆê¸°í™”
            authStatusArea.classList.add('hidden');
            authMessage.textContent = '';
            verifyMissionBtn.disabled = false;
            verifyMissionBtn.textContent = 'AIë¡œ ë¯¸ì…˜ ì¸ì¦í•˜ê¸°';
            verifyMissionBtn.classList.remove('bg-gray-400');
            verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        });

        // AI ì¸ì¦ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        verifyMissionBtn.addEventListener('click', async () => {
            // Firebase ì¸ì¦ ì—¬ë¶€ í™•ì¸ (script.jsì˜ auth ê°ì²´ê°€ ì •ì˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •)
            if (typeof auth === 'undefined' || !auth.currentUser) {
                closeAIAuthModal();
                showModal("ë¡œê·¸ì¸ í•„ìš”", "ë¯¸ì…˜ì„ ì¸ì¦í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            const file = missionImageInput.files[0];
            if (!file) {
                authStatusArea.classList.remove('hidden');
                authStatusArea.classList.add('bg-yellow-100');
                authMessage.style.color = 'orange';
                authMessage.textContent = 'ì¸ì¦ì„ ìœ„í•´ ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                authStatusArea.classList.remove('hidden');
                authStatusArea.classList.add('bg-red-100');
                authMessage.style.color = 'red';
                authMessage.textContent = 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                return;
            }

            verifyMissionBtn.disabled = true;
            verifyMissionBtn.textContent = 'AI ì¸ì¦ ì¤‘...';
            verifyMissionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            verifyMissionBtn.classList.add('bg-gray-400');
            
            authStatusArea.classList.remove('hidden');
            authStatusArea.classList.add('bg-gray-100');
            authMessage.style.color = '#4a5568';
            authMessage.textContent = 'ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';

            // Base64 ì¸ì½”ë”©
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            try {
                const isVerified = await verifyMissionWithAI(base64Data, file.type, currentMission.title, currentMission.description);
                
                authStatusArea.classList.remove('bg-gray-100', 'bg-yellow-100', 'bg-red-100');
                
                if (isVerified) {
                    authStatusArea.classList.add('bg-green-100');
                    authMessage.style.color = 'green';
                    authMessage.textContent = `âœ… ë¯¸ì…˜ ì¸ì¦ ì„±ê³µ! '${currentMission.title}' ë¯¸ì…˜ì„ ì™„ë£Œí•˜ì—¬ ìƒëª…ë ¥ +${AI_INCREMENT}ì„ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    
                    // ğŸŒŸ script.jsì— ì •ì˜ëœ ì „ì—­ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                    if (typeof updateLifeForceAndDisplay === 'function') {
                         // updateLifeForceAndDisplay í•¨ìˆ˜ëŠ” script.jsì—ì„œ ë‚´ë³´ë‚´ê±°ë‚˜ windowì— í• ë‹¹ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                         // í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ì „ì—­ í•¨ìˆ˜ í˜¸ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤.
                         updateLifeForceAndDisplay(AI_INCREMENT, true); // ë‘ ë²ˆì§¸ ì¸ìëŠ” ê°ì¶•ëŸ‰ ì—…ë°ì´íŠ¸ë¥¼ í¬í•¨í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    } else {
                        console.warn("âš ï¸ updateLifeForceAndDisplay í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. script.js íŒŒì¼ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    }
                    
                    setTimeout(closeAIAuthModal, 2500);

                } else {
                    authStatusArea.classList.add('bg-red-100');
                    authMessage.style.color = 'red';
                    authMessage.textContent = 'âŒ ë¯¸ì…˜ ì¸ì¦ ì‹¤íŒ¨. AIê°€ ì‚¬ì§„ì—ì„œ ë¯¸ì…˜ ìˆ˜í–‰ ì¦ê±°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¯¸ì…˜ì— ì í•©í•œ ì‚¬ì§„ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.';
                }

            } catch (error) {
                console.error("AI ì¸ì¦ ì˜¤ë¥˜:", error);
                authStatusArea.classList.remove('bg-gray-100', 'bg-green-100', 'bg-yellow-100');
                authStatusArea.classList.add('bg-red-100');
                authMessage.style.color = 'red';
                authMessage.textContent = 'âš ï¸ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            } finally {
                verifyMissionBtn.disabled = false;
                verifyMissionBtn.textContent = 'AIë¡œ ë¯¸ì…˜ ì¸ì¦í•˜ê¸°';
                verifyMissionBtn.classList.remove('bg-gray-400');
                verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        });

        // ğŸŒŸ AI API í˜¸ì¶œ í•¨ìˆ˜ (í•µì‹¬ ë¡œì§) ğŸŒŸ
        async function verifyMissionWithAI(base64ImageData, mimeType, missionTitle, missionDescription) {
            const systemPrompt = `ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì¹œí™˜ê²½ ë¯¸ì…˜ ìˆ˜í–‰ì„ ì¸ì¦í•˜ëŠ” AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
            ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ ì‘ë‹µí•˜ì„¸ìš”:
            1. ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ì™€ ìš”ì²­ëœ ë¯¸ì…˜ ë‚´ìš©ì´ ì¼ì¹˜í•˜ëŠ”ì§€, ë¯¸ì…˜ ìˆ˜í–‰ì˜ ì¦ê±°ê°€ ëª…í™•í•œì§€ íŒë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.
            2. ì‘ë‹µì€ ì˜¤ì§ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. í…ìŠ¤íŠ¸ë‚˜ ì¶”ê°€ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
            3. JSON í˜•ì‹: {"verification_result": boolean, "reason_kr": string}
            4. 'verification_result'ê°€ trueì´ë©´ ë¯¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ë˜ì—ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            5. 'verification_result'ê°€ falseì´ë©´ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            6. 'reason_kr'ì€ í•œêµ­ì–´ë¡œ ëœ íŒë‹¨ ì´ìœ ì…ë‹ˆë‹¤.`;

            const userQuery = `ë¯¸ì…˜ ì œëª©: '${missionTitle}'. ë¯¸ì…˜ ë‚´ìš©: '${missionDescription}'.
            ì´ ì´ë¯¸ì§€ê°€ ì£¼ì–´ì§„ ë¯¸ì…˜ì„ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰í–ˆìŒì„ ì…ì¦í•˜ëŠ” ì¶©ë¶„í•œ ì¦ê±°ë¥¼ ì œê³µí•©ë‹ˆê¹Œ?`;

            // API í‚¤ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë˜ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ë¡œ ë‘¡ë‹ˆë‹¤.
            const apiKey = ""; 
            
            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=\${apiKey}\`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "verification_result": { "type": "BOOLEAN" },
                            "reason_kr": { "type": "STRING" }
                        }
                    }
                }
            };

            let response;
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            let cleanJsonText = jsonText.replace(/```json\\s*/g, '').replace(/\\s*```/g, '');
                            const parsedJson = JSON.parse(cleanJsonText);
                            return parsedJson.verification_result;
                        }
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error('AI ë¯¸ì…˜ ì¸ì¦ ì„œë²„ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }
        
        // ğŸŒŸ í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ì…˜ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
        // mission-icon-wrapper í´ë¦­ ì‹œì—ë„ loadMissionsë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', loadMissions);
        document.getElementById('mission-icon-wrapper').addEventListener('click', loadMissions);
    </script>
</body>
</html>
