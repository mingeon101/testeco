<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 탄소 오름</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/byMjbXs1/Gemini-Generated-Image-s04wxfs04wxfs04w-1.png?dl=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="simulation-container">
        <div id="game-display-area" class="flex-grow flex flex-col justify-between p-4">
            <header>
                <h1 class="text-3xl sm:text-4xl font-bold">나의 탄소 오름</h1>
            </header>
            
            <main class="flex-grow flex flex-col items-center justify-center">
                <div class="oreum-background">
                    <div id="oreum" class="oreum level-1">
                        <div class="tree-container">
                            <div id="tree1" class="tree"><div class="trunk"></div><div class="leaves"></div></div>
                            <div id="tree2" class="tree"><div class="trunk"></div><div class="leaves"></div></div>
                        </div>
                    </div>
                </div>
            </main>
            
            <div class="dashboard">
                <div class="stat">레벨 <span id="level-value" class="text-2xl sm:text-3xl">1</span></div>
                <div class="stat">생명력 <span id="life-force-value" class="text-2xl sm:text-3xl">0</span></div>
                <div class="stat">감축량 <span id="ghg-reduced-value" class="text-2xl sm:text-3xl">0g</span></div>
            </div>
            
            <div class="sensor-dashboard">
                <p>현재 이동수단: <span id="transport-display" class="font-bold text-blue-600 animate-pulse">대기 중...</span></p>
                <p>현재 속도: <span id="speed-display" class="value">0 m/s</span></p>
                <p>가속도: <span id="acc-display" class="value">0 m/s²</span></p>
                <p id="user-info-display" class="text-xs truncate text-gray-400">로그인하고 오름을 키워보세요!</p>
                <p id="db-status" class="text-xs text-gray-400">Firebase 초기화 중...</p>
            </div>
        </div>
        
        <footer class="w-full border-t border-gray-300 bg-white">
            <nav class="flex justify-around items-center h-16 text-gray-500">
                <a id="mission-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></a>
                <a id="rewards-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg></a>
                <a id="profile-icon-wrapper" class="flex-1 flex justify-center items-center h-full cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></a>
            </nav>
        </footer>
    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title" class="font-bold text-lg mb-2"></h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">확인</button>
        </div>
    </div>
    
    <div id="side-panel-overlay" class="side-panel-overlay">
        <div id="side-panel" class="side-panel">
            <div class="side-panel-header">
                <h2 id="side-panel-title">마이페이지</h2>
                <button id="side-panel-close-btn">&times;</button>
            </div>
            <div class="side-panel-content">
                <div id="logged-out-view">
                    <p class="text-center text-sm mb-4">로그인하고 오름을 키워보세요!</p>
                    <button id="google-sign-in-btn" class="google-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" class="w-6 h-6"><span>Google 계정으로 로그인</span></button>
                </div>
                
                <div id="logged-in-view" class="hidden">
                    <p id="panel-user-info" class="text-center text-sm mb-4">로그인 정보가 없습니다.</p>
                    <div class="flex flex-col gap-4">
                        <div class="stat"><p>현재 레벨</p><span id="panel-level-value">1</span></div>
                        <div class="stat"><p>총 감축량</p><span id="panel-ghg-reduced-value">0g</span></div>
                    </div>
                    
                    <button id="subscribe-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                        알림 구독하기
                    </button>

                    <button id="sign-out-btn" class="mt-8 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">로그아웃</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 보상 모달 -->
    <div id="rewards-modal-overlay" class="rewards-modal-overlay">
        <div id="rewards-modal" class="rewards-modal-content">
            <h2 class="text-2xl font-bold text-gray-800">오늘의 보상</h2>
            <p class="text-sm text-gray-500 mb-4">탄소 감축 활동으로 보상을 획득하세요!</p>
            <div id="reward-list-container" class="flex flex-col gap-3 w-full">
                <!-- 보상 목록이 여기에 동적으로 추가됩니다. -->
            </div>
            <button id="rewards-close-btn" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-full">닫기</button>
        </div>
    </div>
    
    <!-- 미션 모달 (수정됨) -->
    <div id="mission-modal-overlay" class="mission-modal-overlay">
        <div id="mission-modal" class="mission-modal-content">
            <div style="height: 700px; overflow-y: auto">
                <h2 class="text-2xl font-bold text-gray-800">오늘의 미션</h2>
                <p class="text-gray-600 mb-4">친환경 활동으로 생명력을 얻고 오름을 키워보세요!</p>
                <!-- 🌟 미션 목록 동적 컨테이너로 교체 🌟 -->
                <div id="mission-list-container" class="mission-list space-y-3 mt-4 text-left">
                    <!-- 미션 항목이 여기에 JavaScript로 동적으로 로드됩니다. -->
                </div>
                <!-- 🌟 교체 끝 🌟 -->
                <button id="mission-close-btn" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-full">닫기</button>
            </div>
        </div>
    </div>
    <script src="https://www.chatbase.co/embed.min.js" id="KwLJdboX39BEnTOig8OKU"></script>
    <script type="module" src="script.js"></script>

    <!-- ============================================== -->
    <!-- 🌟 새로 추가된 AI 미션 인증 상세 모달 (ai-auth-modal-overlay) 🌟 -->
    <!-- ============================================== -->
    <div id="ai-auth-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex justify-center items-center p-4 transition-opacity duration-300 opacity-0">
        <div class="modal-content-ai bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-start">
                <h3 id="auth-mission-title" class="text-2xl font-bold text-green-700">미션 상세</h3>
                <button class="text-gray-500 hover:text-gray-700 text-3xl leading-none" onclick="closeAIAuthModal()">&times;</button>
            </div>
            <p id="auth-mission-desc" class="text-gray-600 mt-2 mb-4 text-sm border-b pb-3"></p>

            <div id="auth-content">
                <label for="mission-image" class="block text-left text-sm font-medium text-gray-700 mb-2">
                    미션 인증 사진 업로드
                </label>
                <input type="file" id="mission-image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-sm">
                
                <img id="image-preview" class="w-full h-48 object-cover rounded-lg border border-gray-200 hidden mb-4" alt="업로드된 이미지 미리보기">

                <button id="verify-mission-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    AI로 미션 인증하기
                </button>
                
                <div id="auth-status-area" class="mt-4 p-3 rounded-lg text-sm text-left hidden">
                    <p id="auth-message" class="font-medium"></p>
                </div>
            </div>

            <button class="w-full mt-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150" onclick="closeAIAuthModal()">닫기</button>
        </div>
    </div>

    <!-- 🌟 AI 인증 및 동적 미션 로딩 로직 (새로 추가된 내용) 🌟 -->
    <script type="module">
        // 🌟 AI 미션 인증 관련 DOM 요소 및 변수 🌟
        const AI_INCREMENT = 20; // AI 인증 성공 시 추가되는 생명력
        
        const aiAuthModalOverlay = document.getElementById('ai-auth-modal-overlay');
        const authMissionTitle = document.getElementById('auth-mission-title');
        const authMissionDesc = document.getElementById('auth-mission-desc');
        const missionImageInput = document.getElementById('mission-image');
        const imagePreview = document.getElementById('image-preview');
        const verifyMissionBtn = document.getElementById('verify-mission-btn');
        const authStatusArea = document.getElementById('auth-status-area');
        const authMessage = document.getElementById('auth-message');
        
        // 미션 로딩 관련 요소
        const missionListContainer = document.getElementById('mission-list-container');
        
        // 미션 데이터 (데이터베이스 구조를 반영하여 업데이트)
        const MISSION_DATA = [
            { 
                icon: '🚶‍♂️‍➡️', 
                title: '플로깅을 실천하기', 
                description: '조깅하면서 쓰레기를 줍는 활동으로 환경 보호와 운동을 동시에 하세요. (예: 주운 쓰레기 사진)', 
                aiEnabled: true 
            },
            { 
                icon: '🥤', 
                title: '텀블러 사용', 
                description: '일회용 컵 대신 텀블러를 사용해 쓰레기를 줄이세요. (예: 텀블러를 사용하는 사진)', 
                aiEnabled: true 
            },
            { 
                icon: '🪜', 
                title: '계단 이용', 
                description: '가까운 층은 엘리베이터 대신 계단을 이용해 전력 소비를 줄이세요. (AI 인증 가능)', 
                aiEnabled: true 
            },
            { 
                icon: '🖥️', 
                title: '컴퓨터 절전 모드 활용', 
                description: '잠시 자리를 비울 때는 절전 모드로 전환하거나 전원을 끄세요. (일반 인증)', 
                aiEnabled: false 
            },
            { 
                icon: '♻️', 
                title: '택배 박스 재활용', 
                description: '박스에 붙어 있는 테이프, 송장 스티커 등 이물질을 제거하고 박스를 펼쳐 배출하세요. (일반 인증)', 
                aiEnabled: false 
            },
            { 
                icon: '👕', 
                title: '패스트 패션 지양', 
                description: '저렴하고 유행에 따라 자주 바뀌는 옷보다는 오래 입을 수 있는 좋은 옷을 구매하세요. (일반 인증)', 
                aiEnabled: false 
            },
            { 
                icon: '☘️', 
                title: '에코 캠페인 참여', 
                description: '환경 단체에서 주관하는 캠페인이나 서명 운동에 참여하세요. (일반 인증)', 
                aiEnabled: false 
            },
            // 나머지 미션 항목은 AI 인증이 아니므로 임시로 일반 인증 처리
            { 
                icon: '🔌', 
                title: '플러그 뽑기', 
                description: '사용하지 않는 가전제품의 플러그를 뽑아 대기 전력을 차단하세요.', 
                aiEnabled: false 
            },
            { 
                icon: '🌡️', 
                title: '냉난방 온도 조절', 
                description: '여름철에는 에어컨 온도를 26°C 이상으로, 겨울철에는 난방 온도를 20°C 이하로 유지하세요.', 
                aiEnabled: false 
            },
            { 
                icon: '💡', 
                title: '전등 끄기', 
                description: '불필요한 조명은 끄고 에너지를 절약하세요.', 
                aiEnabled: false 
            },
            { 
                icon: '🚰', 
                title: '물 절약', 
                description: '양치할 때 컵 사용하기, 샤워 시간 줄이기 등 물을 아껴 쓰세요.', 
                aiEnabled: false 
            },
            { 
                icon: '💸', 
                title: '친환경 제품 구매', 
                description: '환경마크가 있는 제품이나 재활용 소재로 만든 제품을 구매하세요.', 
                aiEnabled: false 
            },
            { 
                icon: '🥕', 
                title: '중고 물품 활용', 
                description: '필요한 물건은 중고로 구매하거나, 사용하지 않는 물건은 판매하거나 기부하세요.', 
                aiEnabled: false 
            },
            { 
                icon: '🛒', 
                title: '지역 농산물 이용', 
                description: '지역 농산물을 구매해 운송 과정에서 발생하는 탄소 배출량을 줄이세요.', 
                aiEnabled: false 
            },
            { 
                icon: '🍚', 
                title: '잔반 남기지 않기', 
                description: '먹을 만큼만 조리하고 남기지 않아 음식물 쓰레기 및 물 낭비를 줄이세요.', 
                aiEnabled: false 
            }
        ];

        let currentMission = { title: '', description: '' }; // 현재 인증하려는 미션 정보
        
        // 🌟 미션 목록 동적 로드 함수 🌟
        window.loadMissions = function() {
            missionListContainer.innerHTML = ''; // 기존 목록 초기화
            
            MISSION_DATA.forEach(mission => {
                const li = document.createElement('li');
                li.className = 'mission-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-150';
                
                // AI 인증이 가능한 미션만 handleMissionClick 핸들러를 연결
                if (mission.aiEnabled) {
                    // 미션 클릭 시, 미션 모달을 닫고 AI 인증 모달을 엽니다.
                    li.setAttribute('onclick', `closeMissionModal(); handleMissionClick('${mission.icon.replace(/'/g, "\\'") + ' ' + mission.title.replace(/'/g, "\\'")}', '${mission.description.replace(/'/g, "\\'")}')`);
                    li.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 flex items-center">
                            ${mission.icon} ${mission.title}
                            <span class="ml-2 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">AI 인증</span>
                        </h3>
                        <p class="text-sm text-gray-600">${mission.description.split('(')[0].trim()}</p>
                    `;
                } else {
                    // AI 인증이 아닌 미션은 일반 인증 프로세스를 거칩니다. (임시 로직)
                    li.setAttribute('onclick', `closeMissionModal(); showModal('일반 인증', '${mission.title} 미션은 수동 인증이 필요합니다.')`);
                    li.innerHTML = `
                        <h3 class="font-semibold text-lg text-gray-800 flex items-center">
                            ${mission.icon} ${mission.title}
                            <span class="ml-2 text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">수동 인증</span>
                        </h3>
                        <p class="text-sm text-gray-600">${mission.description.split('(')[0].trim()}</p>
                    `;
                }

                missionListContainer.appendChild(li);
            });
        }

        // 🌟 AI 인증 모달 닫기 함수 🌟
        window.closeAIAuthModal = function() {
            aiAuthModalOverlay.classList.add('opacity-0');
            aiAuthModalOverlay.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                aiAuthModalOverlay.classList.add('hidden');
            }, 300);
        }
        
        // 미션 클릭 핸들러: AI 인증 모달을 엽니다.
        window.handleMissionClick = function(title, description) {
            currentMission = { title, description };
            authMissionTitle.textContent = title;
            authMissionDesc.textContent = description.replace(' (예:', ' (AI 분석을 위해 인증 사진이 필요합니다. 예:'); 
            
            // UI 초기화
            missionImageInput.value = '';
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            authStatusArea.classList.add('hidden');
            authMessage.textContent = '';
            verifyMissionBtn.disabled = false;
            verifyMissionBtn.textContent = 'AI로 미션 인증하기';
            verifyMissionBtn.classList.remove('bg-gray-400');
            verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // 모달 표시
            aiAuthModalOverlay.classList.remove('hidden');
            setTimeout(() => {
                aiAuthModalOverlay.classList.remove('opacity-0');
                aiAuthModalOverlay.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        // 이미지 미리보기 및 상태 초기화 리스너
        missionImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
            }
            // 상태 초기화
            authStatusArea.classList.add('hidden');
            authMessage.textContent = '';
            verifyMissionBtn.disabled = false;
            verifyMissionBtn.textContent = 'AI로 미션 인증하기';
            verifyMissionBtn.classList.remove('bg-gray-400');
            verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        });

        // AI 인증 버튼 클릭 핸들러
        verifyMissionBtn.addEventListener('click', async () => {
            // Firebase 인증 여부 확인 (script.js의 auth 객체가 정의되어 있다고 가정)
            if (typeof auth === 'undefined' || !auth.currentUser) {
                closeAIAuthModal();
                showModal("로그인 필요", "미션을 인증하려면 로그인해야 합니다.");
                return;
            }

            const file = missionImageInput.files[0];
            if (!file) {
                authStatusArea.classList.remove('hidden');
                authStatusArea.classList.add('bg-yellow-100');
                authMessage.style.color = 'orange';
                authMessage.textContent = '인증을 위해 사진 파일을 선택해주세요.';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                authStatusArea.classList.remove('hidden');
                authStatusArea.classList.add('bg-red-100');
                authMessage.style.color = 'red';
                authMessage.textContent = '파일 크기가 너무 큽니다. 5MB 이하의 파일을 업로드해주세요.';
                return;
            }

            verifyMissionBtn.disabled = true;
            verifyMissionBtn.textContent = 'AI 인증 중...';
            verifyMissionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            verifyMissionBtn.classList.add('bg-gray-400');
            
            authStatusArea.classList.remove('hidden');
            authStatusArea.classList.add('bg-gray-100');
            authMessage.style.color = '#4a5568';
            authMessage.textContent = '사진을 분석하고 있습니다. 잠시만 기다려주세요...';

            // Base64 인코딩
            const base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            try {
                const isVerified = await verifyMissionWithAI(base64Data, file.type, currentMission.title, currentMission.description);
                
                authStatusArea.classList.remove('bg-gray-100', 'bg-yellow-100', 'bg-red-100');
                
                if (isVerified) {
                    authStatusArea.classList.add('bg-green-100');
                    authMessage.style.color = 'green';
                    authMessage.textContent = `✅ 미션 인증 성공! '${currentMission.title}' 미션을 완료하여 생명력 +${AI_INCREMENT}을 획득했습니다.`;
                    
                    // 🌟 script.js에 정의된 전역 함수를 호출합니다.
                    if (typeof updateLifeForceAndDisplay === 'function') {
                         // updateLifeForceAndDisplay 함수는 script.js에서 내보내거나 window에 할당되어야 합니다.
                         // 현재 스크립트 구조에 맞게 전역 함수 호출을 시도합니다.
                         updateLifeForceAndDisplay(AI_INCREMENT, true); // 두 번째 인자는 감축량 업데이트를 포함하도록 할 수 있습니다.
                    } else {
                        console.warn("⚠️ updateLifeForceAndDisplay 함수를 찾을 수 없습니다. script.js 파일 확인이 필요합니다.");
                    }
                    
                    setTimeout(closeAIAuthModal, 2500);

                } else {
                    authStatusArea.classList.add('bg-red-100');
                    authMessage.style.color = 'red';
                    authMessage.textContent = '❌ 미션 인증 실패. AI가 사진에서 미션 수행 증거를 찾지 못했습니다. 미션에 적합한 사진을 다시 업로드해 주세요.';
                }

            } catch (error) {
                console.error("AI 인증 오류:", error);
                authStatusArea.classList.remove('bg-gray-100', 'bg-green-100', 'bg-yellow-100');
                authStatusArea.classList.add('bg-red-100');
                authMessage.style.color = 'red';
                authMessage.textContent = '⚠️ API 호출 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
            } finally {
                verifyMissionBtn.disabled = false;
                verifyMissionBtn.textContent = 'AI로 미션 인증하기';
                verifyMissionBtn.classList.remove('bg-gray-400');
                verifyMissionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        });

        // 🌟 AI API 호출 함수 (핵심 로직) 🌟
        async function verifyMissionWithAI(base64ImageData, mimeType, missionTitle, missionDescription) {
            const systemPrompt = `당신은 사용자의 친환경 미션 수행을 인증하는 AI 전문가입니다. 
            다음 규칙에 따라 응답하세요:
            1. 사용자가 업로드한 이미지와 요청된 미션 내용이 일치하는지, 미션 수행의 증거가 명확한지 판단해야 합니다.
            2. 응답은 오직 JSON 형식이어야 합니다. 텍스트나 추가 설명은 포함하지 마세요.
            3. JSON 형식: {"verification_result": boolean, "reason_kr": string}
            4. 'verification_result'가 true이면 미션이 성공적으로 인증되었음을 의미합니다.
            5. 'verification_result'가 false이면 인증에 실패했음을 의미합니다.
            6. 'reason_kr'은 한국어로 된 판단 이유입니다.`;

            const userQuery = `미션 제목: '${missionTitle}'. 미션 내용: '${missionDescription}'.
            이 이미지가 주어진 미션을 성공적으로 수행했음을 입증하는 충분한 증거를 제공합니까?`;

            // API 키는 Canvas 환경에서 자동으로 제공되므로 빈 문자열로 둡니다.
            const apiKey = ""; 
            
            const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=\${apiKey}\`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "verification_result": { "type": "BOOLEAN" },
                            "reason_kr": { "type": "STRING" }
                        }
                    }
                }
            };

            let response;
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            let cleanJsonText = jsonText.replace(/```json\\s*/g, '').replace(/\\s*```/g, '');
                            const parsedJson = JSON.parse(cleanJsonText);
                            return parsedJson.verification_result;
                        }
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error('AI 미션 인증 서버 응답을 받을 수 없습니다.');
                    }
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }
        
        // 🌟 페이지 로드 시 미션 목록을 동적으로 로드합니다.
        // mission-icon-wrapper 클릭 시에도 loadMissions를 호출하도록 리스너를 추가합니다.
        document.addEventListener('DOMContentLoaded', loadMissions);
        document.getElementById('mission-icon-wrapper').addEventListener('click', loadMissions);
    </script>
</body>
</html>
